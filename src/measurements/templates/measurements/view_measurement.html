{% extends 'global/pages/main_layout.html' %}
{% block title %}Visualizar Medição{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">{{ measurement.name }}</h2>

    <div class="mb-3">
        <strong>Contrato:</strong> {{ measurement.contract|default:"-" }}<br>
        <strong>Data de Criação:</strong> {{ measurement.start_date|date:"d/m/Y" }}<br>
        <strong>Data de Pagamento:</strong> {{ measurement.payment_date|date:"d/m/Y"|default:"Não definida" }}<br>
        <strong>Valor Desconto:</strong> {{ measurement.discounts|default:"-" }}<br>
        <strong>Detalhes do Desconto:</strong> {{ measurement.discounts_detail|default:"-" }}<br>
        <strong>Valor Final:</strong> {{ measurement.final_value|default:"-" }}
    </div>

    <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <strong>Descrição</strong>
            <a href="{% url 'edit_measurement' measurement.pk %}" class="btn btn-sm btn-outline-warning">Editar</a>
        </div>
        <div class="card-body">
            {% if measurement.description %}
                {{ measurement.description|safe }}
            {% else %}
                <p class="text-muted">Nenhuma descrição adicionada.</p>
            {% endif %}
        </div>
    </div>

    {% if measurement.attachment %}
    <div class="mt-3">
        <strong>Anexo:</strong>
        <a href="{{ measurement.attachment.url }}" download>{{ measurement.attachment.name }}</a>
    </div>
    {% endif %}


    <hr>
    <div class="card mt-4">
        <div class="card-header bg-light">
            <strong>Chat da Medição</strong>
        </div>
        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            {% if messages_list %}
                {% for msg in messages_list %}
                    <div class="mb-2">
                        <strong>{{ msg.user.name }}</strong>
                        <small class="text-muted">— {{ msg.created_at|date:"d/m/Y H:i" }}</small>
                        <p class="mb-1">{{ msg.message|linebreaksbr }}</p>
                        <hr class="my-1">
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">Nenhuma mensagem ainda.</p>
            {% endif %}
        </div>
        <div class="card-footer">
            <form method="post">
                {% csrf_token %}
                {{ form.message }}
                <button type="submit" class="btn btn-primary btn-sm mt-2">Enviar</button>
            </form>
        </div>
    </div>
    
    <div class="mt-4 text-end">
        <a href="{% url 'home' %}" class="btn btn-secondary">Voltar</a>
    </div>
</div>
{% endblock %}

{% extends 'global/pages/main_layout.html' %}
{% block title %}Visualizar Medição{% endblock %}
{% load format_filters %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">{{ measurement.name }}</h2>

    <div class="mb-3">
        <strong>Contrato:</strong> {{ measurement.contract|default:"-" }}<br>
        <strong>Data de Criação:</strong> {{ measurement.start_date|date:"d/m/Y" }}<br>
        <strong>Data de Pagamento:</strong> {{ measurement.payment_date|date:"d/m/Y"|default:"Não definida" }}<br>
        <strong>Valor Desconto:</strong> R$ {{ measurement.discounts|money_format|default:"-" }}<br>
        <strong>Detalhes do Desconto:</strong> {{ measurement.discounts_detail|default:"-" }}<br>
        <strong>Valor Final:</strong> R$ {{ measurement.final_value|money_format|default:"-" }}
    </div>

    <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <strong>Descrição</strong>
            {% if measurement.status != 'Finished' %}
            <a href="{% url 'edit_measurement' measurement.pk %}" class="btn btn-sm btn-outline-warning">Editar</a>
            {% endif %}
        </div>
        <div class="card-body">
            {% if measurement.description %}
                {{ measurement.description|safe }}
            {% else %}
                <p class="text-muted">Nenhuma descrição adicionada.</p>
            {% endif %}
        </div>
    </div>

    {% if measurement.attachment %}
    <div class="mt-3">
        <strong>Anexo:</strong>
        <a href="{{ measurement.attachment.url }}" download>{{ measurement.attachment.name }}</a>
    </div>
    {% endif %}


    <hr>
    <div class="card mt-4">
        <div class="card-header bg-light">
            <strong>Chat da Medição</strong>
        </div>
        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
            {% if messages_list %}
                {% for msg in messages_list %}
                    <div class="mb-2 d-flex justify-content-between align-items-start">
                        <div>
                            <strong>{{ msg.user.first_name }} {{ msg.user.last_name }}</strong>
                            <small class="text-muted">— {{ msg.created_at|date:"d/m/Y H:i" }}</small>
                            <p class="mb-1">{{ msg.message|linebreaksbr }}</p>
                        </div>

                        {% if can_delete_comments %}
                        <form method="post" action="{% url 'delete_message' msg.pk %}" style="margin-left: 10px;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Deseja realmente excluir este comentário?');">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    <hr class="my-1">
                {% endfor %}
            {% else %}
                <p class="text-muted">Nenhuma mensagem ainda.</p>
            {% endif %}
        </div>
        <div class="card-footer">
            <form method="post">
                {% csrf_token %}
                {{ form.message }}
                <button type="submit" class="btn btn-primary btn-sm mt-2">Enviar</button>
            </form>
        </div>
    </div>
    
    {% if can_approve or can_reject %}
    <div class="d-flex justify-content-end gap-2 mt-4">
        {% if can_reject %}
        <form method="post" action="{% url 'reject_measurement' measurement.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-x-circle"></i> Rejeitar
            </button>
        </form>
        {% endif %}
        {% if can_approve %}
        <form method="post" action="{% url 'approve_measurement' measurement.pk %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle"></i>
                {% if next_status == 'PendingManagerApproval' %}
                    Enviar para aprovação do gerente
                {% elif next_status == 'PendingDirectorApproval' %}
                    Enviar para aprovação do diretor
                {% elif next_status == 'Finished' %}
                    Liberar medição
                {% else %}
                    Aprovar
                {% endif %}
            </button>
        </form>
        {% endif %}
    </div>
    {% endif %}



    <div class="mt-4 text-end">
        <a href="{% url 'home' %}" class="btn btn-secondary">Voltar</a>
    </div>

    {% if measurement.status == 'Finished' %}
    <div class="mt-3 text-end">
        <a href="{% url 'generate_email' measurement.pk %}" class="btn btn-outline-primary">
            <i class="bi bi-envelope"></i> Gerar E-mail
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
